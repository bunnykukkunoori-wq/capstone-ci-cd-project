name: CI-CD Pipeline

on:
  push:
    branches: ["main"]

jobs:
  build-test-scan-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: "9148428653"
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Locate Backend Dockerfile
      run: |
       echo "Searching for Dockerfile in backend..."
       find backend -maxdepth 3 -type f -iname "dockerfile*"

    - name: Locate Frontend Dockerfile
      run: |
       echo "Searching Frontend Dockerfile..."
       find frontend -maxdepth 4 -type f -iname "dockerfile*"
      
    - name: Install Trivy
      run: |
       sudo apt-get update
       sudo apt-get install -y wget apt-transport-https gnupg lsb-release
       wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | \
       sudo gpg --dearmor -o /usr/share/keyrings/trivy.gpg
       echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb stable main" | \
       sudo tee /etc/apt/sources.list.d/trivy.list
       sudo apt-get update
       sudo apt-get install -y trivy

    - name: Scan Backend
      run: trivy image --severity HIGH,CRITICAL --exit-code 1 9148428653/backend:latest

    - name: Scan Frontend
      run: trivy image --severity HIGH,CRITICAL --exit-code 1 9148428653/frontend:latest

    - name: Push Images
      run: |
        docker push 9148428653/backend:latest
        docker push 9148428653/frontend:latest

    - name: Deploy to Staging
      run: |
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
        docker pull 9148428653/backend:latest &&
        docker pull 9148428653/frontend:latest &&
        docker-compose -f /home/app/docker-compose.yml up -d --force-recreate
        "





